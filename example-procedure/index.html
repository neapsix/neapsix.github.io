<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Make Your Container Application Available to Internal and External Users</title></head><body><header id=banner><h2><a href>neap space</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Make Your Container Application Available to Internal and External Users</h1></header><p>To make your web application available to users both on the internal network and over the internet, while keeping domain name service (DNS) configuration simple, you can host the application on two subdomains of the neap.space domain:</p><ul><li><code>&lt;your application>.apps.neap.space</code>, which is resolved only on the internal network.</li><li><code>&lt;your application>.proxy.neap.space</code>, which is resolved over the public internet.</li></ul><p>Complete the steps in the following sections to make a container application available to users by adding it to the reverse proxy rules for each subdomain. These steps apply only to applications in a container runtime such as Docker or Podman that you configure using Docker Compose.</p><blockquote><p><strong>Prerequisites:</strong>
For both internal and external access:</p><ul><li>An authorized SSH key and sudo access on the proxy.neap.space server.</li><li>Wireguard installed on the container host.</li><li>A container for Traefik on the same host as your application.
For external access:</li><li>Wireguard installed on the container host.</li><li>For your application, bridge networking enabled and ports published on the container host.</li><li>An authorized SSH key and sudo access on the proxy.neap.space server.</li></ul></blockquote><blockquote><p><strong>Why use two different subdomains?</strong></p><p>The neap.space network uses this configuration to avoid creating a split-horizon DNS, where one domain name is resolved differently depending on whether a user accesses it from internal network, the internet, or another specified DNS zone.</p><p>While split-horizon DNS gives users one domain name to use everywhere, separate subdomains can help you avoid issues where a request goes to a different DNS server than you expect. For example, applications like Chrome might prioritize a certain public DNS server over the local one, causing internal requests to be resolved as though they were from the public internet.</p></blockquote><blockquote><p><strong>Prerequisites:</strong></p><ul><li>An authorized SSH key and sudo access on the proxy.neap.space server.</li><li>Wireguard installed on the container host.</li><li>A container for your application</li><li>For external access, bridge networking enabled and an open port published on the container host.</li><li>A container for Traefik on the container host.</li></ul></blockquote><h2 id=let-users-access-the-application-from-your-network>Let Users Access the Application from Your Network</h2><p>First, make sure the local DNS server has an entry that points the application&rsquo;s internal URL to your container host. You might have a specific entry for <code>&lt;application>.apps.neap.space</code> or a wildcard entry for <code>*.apps.neap.space</code>.</p><p>Then, configure Traefik on the container host to match requests to <code>&lt;application>.apps.neap.space</code> and route them to your container using the container runtime&rsquo;s internal routing:</p><ol><li><p>In your Docker Compose file, add the following parameters to the Traefik container if you haven&rsquo;t already.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>command</span>:
  <span style=color:#6272a4># Reverse proxy to docker containers. Each container must have &#34;traefik.enable=true&#34; in labels</span>
  - <span style=color:#f1fa8c>&#34;--providers.docker=true&#34;</span>
  - <span style=color:#f1fa8c>&#34;--providers.docker.exposedbydefault=false&#34;</span>
  <span style=color:#6272a4># Define entry points a user hits when going to http://&lt;domain&gt; and https://&lt;domain&gt;</span>
  - <span style=color:#f1fa8c>&#34;--entrypoints.web.address=:80&#34;</span>
  - <span style=color:#f1fa8c>&#34;--entrypoints.websecure.address=:443&#34;</span>
</code></pre></div></li><li><p>Go to the definition for your container and add the following metadata. Replace <code>&lt;application></code> with the name of your application.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>labels</span>:
  <span style=color:#6272a4># Enable resolution on the internal domain with traefik</span>
  - <span style=color:#f1fa8c>&#34;traefik.enable=true&#34;</span>
  - <span style=color:#f1fa8c>&#34;traefik.http.routers.testsite.rule=Host(`&lt;application&gt;.apps.neap.space`)&#34;</span>
  - <span style=color:#f1fa8c>&#34;traefik.http.routers.testsite.entrypoints=web,websecure&#34;</span>
</code></pre></div></li><li><p>Run <code>docker-compose up -d</code> to start your containers.</p></li></ol><p>Note that this configuration allows insecure HTTP access from the internal network. For testing purposes and small secure networks, you might not need secure HTTPS access. If you want to modify this configuration to use HTTPS, refer to the <a href=https://doc.traefik.io/traefik/v1.7/user-guide/docker-and-lets-encrypt/>Docker & Let&rsquo;s Encrypt</a> topic in the Traefik documentation.</p><h2 id=let-users-access-the-application-from-the-public-internet>Let Users Access the Application from the Public Internet</h2><p>The public DNS records for the neap.space domain already have an entry pointing the <code>*.proxy.neap.space</code> subdomain to a reverse proxy server, and that server has a valid TLS certificate for <code>*.proxy.neap.space</code>. Because these steps are done for you, you don&rsquo;t need to do anything to set up name resolution or a TLS certificate for external access to your application.</p><p>Complete these tasks to enable external access:</p><ul><li>Create a tunnel between the container host and the proxy.neap.space reverse proxy server.</li><li>Add a reverse proxy rule that redirects requests for your application to the container host and your container&rsquo;s published port over the tunnel you created.</li></ul><h3 id=set-up-a-tunnel-with-the-reverse-proxy-server>Set Up a Tunnel with the Reverse Proxy Server</h3><p>First, create the secure tunnel using Wireguard. The tunnel should have two peers: the reverse proxy server and the container host. They should be assigned IP addresses on a subnet that doesn&rsquo;t overlap with anything else on the network. For steps to set up and enable a Wireguard tunnel, refer to the <a href=https://www.wireguard.com/quickstart/>Quick Start</a> topic in the Wireguard documentation.</p><h3 id=add-a-rule-to-the-reverse-proxy-configuration>Add a Rule to the Reverse Proxy Configuration</h3><p>Next, update the reverse proxy server configuration on the proxy.neap.space host to redirect requests for <code>&lt;application>.proxy.neap.space</code> to your container host&rsquo;s IP address and your container&rsquo;s published port.</p><p>The proxy.neap.space server runs nginx with a simple configuration to redirect URLs to specific IP addresses. To add your application to the list, you can work from a template nginx configuration file and fill in the details for your container.</p><ol><li><p>In your Docker Compose file, make sure that the container publishes ports on the host. For example, you might have this line:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>ports</span>:
    - <span style=color:#f1fa8c>&#34;58001:80&#34;</span> <span style=color:#6272a4># Port 58001 on the host is mapped to port 80 on the container.</span>
</code></pre></div></li><li><p>Run <code>ssh &lt;user>@proxy.neap.space</code> to access the reverse proxy server. Use your authorized key.</p></li><li><p>Make a new copy of the template configuration and add it to the enabled sites directory.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo cp /etc/nginx/sites-available/example.proxy.neap.space.conf <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>/etc/nginx/sites-enabled/&lt;application&gt;.proxy.neap.space.conf
</code></pre></div></li><li><p>Open your copy with your preferred text editor, and update the following lines. Replace the text in angle brackets with the details for your container application.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>&lt;application&gt;.proxy.neap.space</span> <span style=color:#f1fa8c>www.&lt;application&gt;.proxy.neap.space</span>;
<span style=color:#ff79c6>set</span> <span style=color:#8be9fd;font-style:italic>$upstream</span> <span style=color:#f1fa8c>&lt;IP</span> <span style=color:#f1fa8c>of</span> <span style=color:#f1fa8c>tunneled</span> <span style=color:#f1fa8c>host&gt;:&lt;Published</span> <span style=color:#f1fa8c>port</span> <span style=color:#f1fa8c>of</span> <span style=color:#f1fa8c>website&gt;</span>;
</code></pre></div></li><li><p>Restart nginx to deploy your configuration. To do so, run <code>sudo systemctl restart nginx</code>.</p></li></ol></article></main><footer id=footer>Copyright Â© 2021 Benjamin Spiegel</footer></body></html>